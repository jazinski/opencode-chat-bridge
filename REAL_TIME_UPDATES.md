# Real-Time Workflow Status Updates

## Overview

The Azure DevOps integration now provides **real-time status updates**
throughout the workflow execution lifecycle, giving users immediate feedback and
progress tracking.

## New Features

### 1. ðŸ‘€ Immediate Acknowledgment

**When:** Webhook received and bot mentioned **Action:** Posts comment with eyes
emoji **Message:** "ðŸ‘€ Got it! Starting workflow..." **Purpose:** Let users know
their request was received instantly

### 2. ðŸ·ï¸ Work Item Tagging

**When:** Workflow starts **Action:** Adds `AI-Processing` tag to work item
**Purpose:** Visual indicator in Azure DevOps boards that AI is working on this
item **Cleanup:** Tag automatically replaced with `AI-Complete` or `AI-Failed`
when done

### 3. ðŸš€ Workflow Start Notification

**When:** After validation and setup **Action:** Posts detailed start message
**Message includes:**

- Workflow name
- Number of agents
- Execution strategy (parallel vs sequential)
- Estimated completion time
- Progress update promise for sequential workflows

**Example:**

```
ðŸš€ **Workflow Started: Accessibility Scan Workflow**

Executing 3 specialized agents to systematically investigate your request.

â±ï¸ Estimated completion: 25 minutes

ðŸ“Š I'll post updates as each agent completes.
```

### 4. ðŸ“Š Progress Updates (Sequential Workflows Only)

**When:** Each agent completes in sequential workflows **Action:** Posts
progress comment **Message includes:**

- Checkmark emoji
- Current progress (e.g., "Agent 2/3")
- Agent name
- Next step indicator

**Example:**

```
âœ… Agent 1/3 completed: **WCAG 2.1 AA Compliance Specialist**

â³ Starting agent 2/3...
```

**Why sequential only?**

- Parallel workflows complete all agents simultaneously
- Sequential workflows have meaningful intermediate milestones
- Prevents comment spam (3 parallel agents = 3 comments at once)

### 5. âœ… Completion Status

**When:** Workflow finishes successfully **Actions:**

- Removes `AI-Processing` tag
- Adds `AI-Complete` tag
- Posts full results with synthesis

**Example:**

```
âœ… **Workflow Complete: Accessibility Scan Workflow**

â±ï¸ Duration: 23 minutes
ðŸ¤– Agents: 3

---

[Full accessibility audit with WCAG findings, remediation plan, etc.]

---

*Generated by @appski multi-agent workflow system*
```

### 6. âŒ Failure Handling

**When:** Workflow encounters error **Actions:**

- Removes `AI-Processing` tag
- Adds `AI-Failed` tag
- Posts error message with details

## User Experience Timeline

### Parallel Workflow (e.g., Research)

```
1. ðŸ‘€ Got it! Starting workflow...                    [Instant]
2. ðŸ·ï¸ Tag added: AI-Processing                        [Instant]
3. ðŸš€ Workflow Started: Research Workflow             [~2 seconds]
   "ðŸ”„ All agents running in parallel..."
4. [12 minutes of processing - no intermediate posts]
5. âœ… Workflow Complete                               [~12 min]
   ðŸ·ï¸ Tag changed: AI-Complete
```

### Sequential Workflow (e.g., Accessibility Scan)

```
1. ðŸ‘€ Got it! Starting workflow...                    [Instant]
2. ðŸ·ï¸ Tag added: AI-Processing                        [Instant]
3. ðŸš€ Workflow Started: Accessibility Scan            [~2 seconds]
   "ðŸ“Š I'll post updates as each agent completes."
4. âœ… Agent 1/3 completed: WCAG Specialist           [~10 min]
5. âœ… Agent 2/3 completed: Testing Strategist        [~18 min]
6. âœ… Agent 3/3 completed: Remediation Expert        [~25 min]
   "ðŸŽ¯ All agents complete! Synthesizing results..."
7. âœ… Workflow Complete                               [~25 min]
   ðŸ·ï¸ Tag changed: AI-Complete
```

## Implementation Details

### Event-Driven Architecture

The system uses EventEmitter pattern to track workflow progress:

```typescript
workflowEngine.on('task.completed', async (event) => {
  // Post progress update to Azure DevOps
  await azureDevOpsClient.addWorkItemComment(...);
});
```

### Listener Management

- **Registration:** Before `executeWorkflow()` call
- **Cleanup:** After workflow completes (success or failure)
- **Scoping:** Listener checks for sequential strategy to avoid spam

### Tag Management

Work items can have multiple tags, so we use:

- `op: 'add'` to add new tags
- `op: 'remove'` to remove tags by exact value
- Tags are comma-separated in Azure DevOps

### Error Resilience

- If comment posting fails, workflow continues (logged as warning)
- If tagging fails, workflow continues (logged as warning)
- User still gets results at the end even if intermediate updates fail

## Benefits

### For Users

1. **Instant feedback** - Know your request was received
2. **Progress visibility** - See work happening in real-time
3. **Time awareness** - Understand how long to wait
4. **Board visibility** - Tags show AI status at a glance
5. **No refresh needed** - Azure DevOps auto-updates comments

### For Teams

1. **Transparency** - Everyone sees AI work in progress
2. **Auditability** - Full timeline of AI involvement
3. **Filtering** - Can filter boards by AI-Processing/AI-Complete tags
4. **Dashboards** - Can create widgets showing AI work items

### For Debugging

1. **Timestamp trail** - Each comment has timestamp
2. **Progress markers** - See exactly where workflow stopped if failed
3. **Duration tracking** - Actual vs estimated time comparison
4. **Event logging** - All updates logged for troubleshooting

## Configuration

No additional configuration needed! The feature works automatically for all
workflows.

### Customization Options (Future)

Potential future enhancements:

- `ENABLE_PROGRESS_UPDATES=true/false` - Toggle progress comments
- `PROGRESS_UPDATE_FREQUENCY=all|milestones|none` - Control verbosity
- `COMPLETION_TAG_PREFIX=AI-` - Customize tag names
- `PROGRESS_EMOJI_STYLE=default|minimal|verbose` - Emoji preferences

## Technical Architecture

### Files Modified

1. **`src/webhooks/routes.ts`**
   - Added immediate acknowledgment comment
   - Added work item tagging logic
   - Added progress tracking event listener
   - Added tag cleanup on completion

2. **`src/orchestration/WorkflowEngine.ts`**
   - Modified `task.completed` event to include `taskName`
   - Ensures sequential and parallel workflows emit consistent events

### Event Flow

```
User mentions bot â†’ Webhook received
    â†“
ðŸ‘€ Acknowledgment posted
    â†“
AI-Processing tag added
    â†“
ðŸš€ Start message posted
    â†“
Event listener registered
    â†“
Workflow.executeWorkflow() called
    â†“
[Sequential: Post update after each agent]
    â†“
Workflow completes
    â†“
Listener cleaned up
    â†“
Tags updated (AI-Complete/AI-Failed)
    â†“
âœ… Results posted
```

### API Calls Summary

**Minimal workflow (parallel, success):**

1. POST comment (acknowledgment)
2. PATCH work item (add AI-Processing tag)
3. POST comment (start message)
4. PATCH work item (update tags to AI-Complete)
5. POST comment (results)

**Total: 5 API calls**

**Sequential workflow with 3 agents (success):**

1. POST comment (acknowledgment)
2. PATCH work item (add AI-Processing tag)
3. POST comment (start message)
4. POST comment (agent 1 done)
5. POST comment (agent 2 done)
6. POST comment (agent 3 done)
7. PATCH work item (update tags to AI-Complete)
8. POST comment (results)

**Total: 8 API calls**

### Rate Limiting Considerations

Azure DevOps API limits:

- **Rate limit:** ~200 requests per minute per PAT
- **Our usage:** Max ~8 calls per workflow
- **Concurrent workflows:** Can handle 20+ simultaneous workflows safely

No throttling implemented currently - API limits are generous for our use case.

## Testing

### Manual Testing Steps

1. **Test Immediate Acknowledgment:**
   ```
   Comment: @appski research modern web frameworks
   Expected: ðŸ‘€ comment appears within 1 second
   ```

2. **Test Tagging:**
   ```
   Action: Check work item tags after posting comment
   Expected: "AI-Processing" tag visible in Azure DevOps
   ```

3. **Test Sequential Progress:**
   ```
   Comment: @appski accessibility scan
   Expected: Progress updates after agents 1, 2, 3 complete
   ```

4. **Test Parallel (No Progress):**
   ```
   Comment: @appski research distributed systems
   Expected: No intermediate updates, just start and finish
   ```

5. **Test Completion Tagging:**
   ```
   Action: Wait for workflow to finish
   Expected: "AI-Processing" removed, "AI-Complete" added
   ```

### Monitoring Commands

**Watch real-time logs:**

```bash
journalctl --user -u opencode-chat-bridge -f | grep -i "comment\|tag\|progress"
```

**Check Azure DevOps calls:**

```bash
journalctl --user -u opencode-chat-bridge --since "10 minutes ago" | grep "Adding comment\|Updating work item"
```

**Verify event emissions:**

```bash
journalctl --user -u opencode-chat-bridge --since "10 minutes ago" | grep "task.completed"
```

## Troubleshooting

### Progress Updates Not Appearing

**Symptom:** No intermediate comments for sequential workflows

**Check:**

1. Verify workflow is actually sequential:
   `grep "strategy.*sequential" src/orchestration/workflows/examples.ts`
2. Check event listener registration: `journalctl | grep "task.completed"`
3. Verify comment API succeeds: `journalctl | grep "Comment added successfully"`

**Common causes:**

- Workflow defined as parallel instead of sequential
- Event listener not registered before execution starts
- Azure DevOps API rate limiting (unlikely)

### Tags Not Updating

**Symptom:** Work item still shows "AI-Processing" after completion

**Check:**

1. Verify tag update API calls: `journalctl | grep "Updating work item"`
2. Check for errors: `journalctl | grep "Failed to update work item"`
3. Verify PAT has work item write permissions

**Common causes:**

- PAT missing "Work Items (Write)" scope
- Tag update request failed but workflow continued (by design)
- Azure DevOps permissions issue

### Duplicate Comments

**Symptom:** Multiple progress comments posted simultaneously

**Check:**

1. Verify listener cleanup: `journalctl | grep "Clean up listener"`
2. Check if multiple workflows triggered:
   `journalctl | grep "Starting workflow"`

**Common causes:**

- Event listener not cleaned up (should be automatic)
- Multiple webhooks received for same comment
- Race condition (rare)

### Missing Acknowledgment

**Symptom:** No ðŸ‘€ comment appears

**Check:**

1. Verify webhook received: `journalctl | grep "Received Azure DevOps webhook"`
2. Check bot mention parsed: `journalctl | grep "Bot mentioned"`
3. Verify API client configured:
   `journalctl | grep "Azure DevOps API client initialized"`

**Common causes:**

- Bot not mentioned correctly (`@appski` required)
- Azure DevOps PAT not configured
- Network connectivity issue

## Future Enhancements

### Priority 1 (High Value)

- **Emoji reactions on work item** - Add reactions to comments instead of new
  comments
- **Estimated time remaining** - Calculate and update ETA as agents complete
- **Cancellation support** - Add "Cancel" button/command to stop workflow
  mid-flight
- **Retry failed agents** - Allow retry of individual failed agents without
  rerunning entire workflow

### Priority 2 (Nice to Have)

- **Progress bar in comment** - Update single comment with progress bar instead
  of multiple comments
- **Agent output preview** - Include snippet of agent output in progress updates
- **Workflow queue status** - Show position in queue if multiple workflows
  running
- **Performance metrics** - Add actual duration vs estimated in progress updates

### Priority 3 (Polish)

- **Custom emoji sets** - Allow teams to configure their preferred emoji style
- **Notification preferences** - Let users opt-in/out of progress updates
- **Webhook for completion** - Trigger external systems when workflow completes
- **Dashboard widget** - Real-time widget showing active AI workflows

## Performance Impact

### Added Latency

- **Acknowledgment:** ~200ms (one API call)
- **Tagging:** ~300ms (one API call)
- **Progress updates:** ~200ms per update (amortized, non-blocking)

**Total overhead:** ~500ms before workflow starts, negligible during execution

### Resource Usage

- **Memory:** Negligible (event listeners are lightweight)
- **CPU:** Negligible (just string formatting and HTTP requests)
- **Network:** ~5-8 additional API calls per workflow

### Scalability

Current implementation scales to:

- **Concurrent workflows:** 20+ (limited by API rate limits, not implementation)
- **Workflow length:** No limit (each update is independent)
- **Comment length:** Azure DevOps limit is 150,000 characters per comment

## Conclusion

The real-time status updates feature dramatically improves user experience by:

1. Providing instant feedback
2. Setting clear expectations
3. Showing work in progress
4. Enabling better workflow tracking

All without significant performance overhead or complexity!

**Next steps:** Deploy and gather user feedback on:

- Are progress updates too frequent/infrequent?
- Do users prefer reactions vs comments?
- Should we add estimated time remaining?
- Are tags useful for filtering/dashboards?
